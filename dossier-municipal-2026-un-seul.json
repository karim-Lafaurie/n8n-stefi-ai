{
  "nodes": [
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "prompt_global",
              "name": "prompt_global",
              "type": "string",
              "value": "R√©alise une analyse municipale compl√®te de {{ $json.ville_nom }} en France pour un dossier √©lectoral municipal 2026. Couvre TOUS ces aspects : 1) ACTUALIT√â R√âCENTE (12 derniers mois) : √©v√©nements, projets municipaux, d√©veloppements √©conomiques, probl√®mes sociaux, d√©cisions du conseil municipal. 2) SITUATION FINANCI√àRE : budget municipal, d√©penses principales, recettes, endettement, investissements r√©cents, projets financ√©s, perspectives budg√©taires. 3) ASPECTS JURIDIQUES : d√©lib√©rations municipales r√©centes, contentieux en cours, d√©cisions administratives importantes, projets d'urbanisme, r√©glementations locales. 4) SOCIO-√âCONOMIQUE : d√©mographie, ch√¥mage, entreprises locales, commerces, immobilier, √©ducation, sant√©, transports, culture, √©quipements publics. Structure ta r√©ponse avec ces 4 sections distinctes et d√©taill√©es."
            },
            {
              "id": "ea9f56dd-4783-4eaa-80ea-fe2bca6a7ad3",
              "name": "prompt_perplexity_1",
              "value": "=R√©alise une analyse strat√©gique et exhaustive de la commune de {{ $json.ville_nom }} code postal {{ $json.cp }} (France), √† destination d'un candidat aux √©lections municipales de 2026.  Structure ton analyse en 8 sections :  1. FICHE COMMUNALE & GOUVERNANCE : - Population, densit√©, maire actuel, dur√©e du mandat - Intercommunalit√©, comp√©tences transf√©r√©es - Conseil municipal, commissions, d√©lib√©rations r√©centes  2. ACTUALIT√â LOCALE & TRANSFORMATIONS : - √âv√©nements des 12 derniers mois - Projets d'am√©nagement, tensions, changements - Perception publique et relais m√©diatiques  3. FINANCES & FISCALIT√â : - Budget, CAF, taux d'endettement, marges de man≈ìuvre - Fiscalit√© locale (fonci√®re, habitation r√©siduelle) - Subventions, contractualisation avec l'√âtat ou la r√©gion  4. URBANISME & JURIDIQUE : - PLU/PLUi, zonages, contentieux en cours - Contraintes patrimoniales ou environnementales  5. PROFIL SOCIO-√âCONOMIQUE : - Donn√©es INSEE : d√©mographie, emploi, revenus, logement - √âvolution r√©cente, dynamique territoriale  6. DONN√âES √âLECTORALES : - R√©sultats municipales 2020, autres √©lections r√©centes - Abstention, tendances politiques locales  7. VIE LOCALE & PATRIMOINE : - Associations, √©quipements, commerces, attractivit√© - Cadre de vie, patrimoine b√¢ti et naturel  8. ENJEUX STRAT√âGIQUES 2026 : - D√©fis prioritaires, axes de campagne potentiels  Consignes : - Style professionnel, synth√©tique (max 5 pages) - Utiliser des donn√©es chiffr√©es, sources officielles (INSEE, Legifrance, data.gouv.fr) - L'analyse doit √™tre exploitable politiquement dans le cadre d'une campagne.",
              "type": "string"
            },
            {
              "id": "47f8cb10-457d-4490-8004-f8150017d200",
              "name": "prompt_perplexity_test_1",
              "value": "Donne moi des informations de population et le maire actuel pour la commune de {{ $json.ville_nom }} code postal {{ $json.cp }} (France)",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "e7f1734d-7ec5-4eb1-afd1-db9cea0cdd53",
      "name": "üîß Configuration du Prompt",
      "type": "n8n-nodes-base.set",
      "position": [
        -1100,
        -40
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "path": "dossier-municipal",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "7ed8322c-96e9-4c37-8aac-854b5426a290",
      "name": "üì• Webhook Entr√©e",
      "type": "n8n-nodes-base.webhook",
      "position": [
        -1320,
        -40
      ],
      "webhookId": "dossier-municipal-2026",
      "typeVersion": 2
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "ville_nom",
              "name": "ville_nom",
              "type": "string",
              "value": "={{ $json.query.ville }}"
            },
            {
              "id": "ef819d74-93d3-4ec2-a7a3-2e3e6a1136fa",
              "name": "code_postal",
              "value": "={{ $json.query.cp }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "8f7c16e2-f38c-42bc-90e8-0aea4b7a4d29",
      "name": "üèõÔ∏è Extraction Nom Ville",
      "type": "n8n-nodes-base.set",
      "position": [
        -880,
        -40
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "ville-existe",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              },
              "leftValue": "={{ $('üèõÔ∏è Extraction Nom Ville').item.json.ville_nom }}",
              "rightValue": ""
            }
          ]
        },
        "options": {}
      },
      "id": "4bbcdd7c-39ae-469c-964e-58079dff091b",
      "name": "‚úÖ V√©rification Ville",
      "type": "n8n-nodes-base.if",
      "position": [
        -640,
        -40
      ],
      "typeVersion": 2.2
    },
    {
      "parameters": {
        "model": "sonar-pro",
        "messages": {
          "messagesUi": [
            {
              "role": "system",
              "content": "Tu es un expert en analyse municipale et en intelligence territoriale. R√©ponds en fran√ßais avec des informations pr√©cises et v√©rifiables."
            },
            {
              "content": "={{ $json.mode === 'test' ? $json.prompt_perplexity_test_1 : $json.prompt_perplexity_1 }}"
            }
          ]
        },
        "additionalFields": {}
      },
      "id": "72dd600b-d200-4b67-8832-4eb494b2629e",
      "name": "üîç Agent Perplexity Global",
      "type": "@watzon/n8n-nodes-perplexity.perplexity",
      "position": [
        -380,
        -40
      ],
      "typeVersion": 1,
      "credentials": {
        "perplexityApi": {
          "id": "l9xmENBp3vpHTyQe",
          "name": "Perplexity account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "ville",
              "name": "ville",
              "type": "string",
              "value": "={{ $('üèõÔ∏è Extraction Nom Ville').item.json.ville_nom }}"
            },
            {
              "id": "analyse_complete",
              "name": "analyse_plerplexity_1",
              "type": "string",
              "value": "={{ $json.choices[0].message.content || 'Donn√©es d\\'analyse non disponibles' }}"
            },
            {
              "id": "86c2360b-1215-4c89-81d3-3e25e7018acc",
              "name": "search_results_plerplexity_1",
              "value": "={{ $json.search_results }}",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "id": "c1a2ab15-4008-4faf-93e4-f609dd21643b",
      "name": "üìä Consolidation Donn√©es",
      "type": "n8n-nodes-base.set",
      "position": [
        -120,
        -40
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Cr√©√© un dossier municipal complet pour un candidat aux √©lections municipales 2026 de {{ $json.ville }}. Synth√©tise les informations fournies et structure le contenu avec des sections claires : Pr√©sentation de la commune, Enjeux principaux, D√©fis √† relever, Opportunit√©s de d√©veloppement, et Recommandations strat√©giques pour la campagne.\n\n## Analyse compl√®te :\n{{ $json.analyse_complete }}\n\n---\n\nCr√©e un dossier municipal structur√© en format JSON avec cette structure exacte :\n\n{\n  \"dossier\": {\n    \"ville\": \"nom de la ville\",\n    \"date_creation\": \"date actuelle\",\n    \"resume_executif\": \"r√©sum√© en 2-3 phrases\",\n    \"sections\": {\n      \"presentation_commune\": {\n        \"titre\": \"Pr√©sentation de la commune\",\n        \"contenu\": \"description d√©taill√©e\",\n        \"points_cles\": [\"point1\", \"point2\", \"point3\"]\n      },\n      \"enjeux_principaux\": {\n        \"titre\": \"Enjeux principaux\",\n        \"contenu\": \"analyse des enjeux\",\n        \"points_cles\": [\"enjeu1\", \"enjeu2\", \"enjeu3\"]\n      },\n      \"defis_relever\": {\n        \"titre\": \"D√©fis √† relever\",\n        \"contenu\": \"identification des d√©fis\",\n        \"points_cles\": [\"defi1\", \"defi2\", \"defi3\"]\n      },\n      \"opportunites\": {\n        \"titre\": \"Opportunit√©s de d√©veloppement\",\n        \"contenu\": \"analyse des opportunit√©s\",\n        \"points_cles\": [\"opportunite1\", \"opportunite2\", \"opportunite3\"]\n      },\n      \"recommandations\": {\n        \"titre\": \"Recommandations strat√©giques\",\n        \"contenu\": \"strat√©gies pour la campagne\",\n        \"points_cles\": [\"recommandation1\", \"recommandation2\", \"recommandation3\"]\n      }\n    },\n    \"sources\": [\"source1\", \"source2\", \"source3\"]\n  }\n}\n\nR√©ponds uniquement avec le JSON, sans texte d'explication."
      },
      "id": "1f9e7f37-e585-48bc-9bac-8668ba6b882f",
      "name": "üìã Cr√©ation Dossier Municipal",
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "position": [
        420,
        -40
      ],
      "typeVersion": 1.4
    },
    {
      "parameters": {
        "model": "gpt-4o-mini-2024-07-18",
        "options": {
          "responseFormat": "json_object",
          "temperature": 0.1
        }
      },
      "id": "b46df901-4678-4e86-8c21-1ba607abd259",
      "name": "ü§ñ GPT Dossier",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "position": [
        340,
        280
      ],
      "typeVersion": 1,
      "credentials": {
        "openAiApi": {
          "id": "x5omHDQyKcMdm5sj",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "model": "gpt-4o-mini-2024-07-18",
        "options": {
          "responseFormat": "text",
          "temperature": 0.1
        }
      },
      "id": "92738708-9e32-4b71-b9de-a6bf8a48c7a2",
      "name": "üåê GPT HTML",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "position": [
        720,
        240
      ],
      "typeVersion": 1,
      "credentials": {
        "openAiApi": {
          "id": "x5omHDQyKcMdm5sj",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Cr√©e un document HTML complet et moderne pour ce dossier municipal. Utilise TailwindCSS pour un design professionnel et responsive.\n\nStructure :\n- Header avec le nom de la ville et date\n- Navigation par sections\n- Contenu organis√© avec des cartes TailwindCSS\n- Code couleur : bleu pour les titres, vert pour les opportunit√©s, orange pour les d√©fis\n- Footer avec les sources\n\nDonn√©es du dossier :\n{{ $json.text }}\n\nRequirements :\n- Document HTML complet avec doctype\n- Utilise TailwindCSS via CDN\n- Design responsive et moderne\n- Navigation fluide entre sections\n- Formatage professionnel pour un candidat\n- Langue fran√ßaise exclusivement\n- Une seule ligne de HTML (sans retours √† la ligne)\n\nR√©ponds uniquement avec le code HTML, sans explications."
      },
      "id": "c0bd6cfa-422a-4da0-b782-43c165a4026f",
      "name": "üé® G√©n√©ration HTML",
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "position": [
        860,
        -40
      ],
      "typeVersion": 1.4
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "={{ $json.text }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "text/html; charset=utf-8"
              }
            ]
          }
        }
      },
      "id": "708cf986-c214-4e14-990d-c6dc0d96227b",
      "name": "üì§ R√©ponse Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "position": [
        1260,
        -40
      ],
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "erreur",
              "name": "erreur",
              "type": "string",
              "value": "Erreur : Nom de ville manquant. Veuillez sp√©cifier le param√®tre 'ville' ou 'topic' dans votre requ√™te. Exemples: ?ville=Paris ou ?topic=Lyon"
            },
            {
              "id": "debug_data",
              "name": "debug_data",
              "type": "object",
              "value": "={{ $('üì• Webhook Entr√©e').item.json }}"
            }
          ]
        },
        "options": {}
      },
      "id": "61371fa4-875a-49bf-9dee-f8d28b57d003",
      "name": "‚ùå Erreur Ville Manquante",
      "type": "n8n-nodes-base.set",
      "position": [
        -400,
        420
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { \"erreur\": $json.erreur, \"debug\": $json.debug_data, \"aide\": \"Utilisez les param√®tres: ?ville=NomVille ou ?topic=NomVille\" } }}",
        "options": {}
      },
      "id": "18194104-17e7-437b-ac90-87616315e2a2",
      "name": "üì§ R√©ponse Erreur",
      "type": "n8n-nodes-base.respondToWebhook",
      "position": [
        -120,
        420
      ],
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "content": "## üèõÔ∏è WORKFLOW DOSSIER MUNICIPAL 2026 - VERSION SIMPLIFI√âE\n\nCe workflow g√©n√®re un dossier complet pour un candidat aux √©lections municipales.\n\n### Utilisation :\n- URL : /dossier-municipal?ville=NOM_VILLE&cp=CODEPOSTAL\n- Exemple : /dossier-municipal?ville=Lyon\n\n### Architecture simplifi√©e :\n- üîç Un seul agent Perplexity global\n- üìä Consolidation directe\n- üé® G√©n√©ration HTML finale\n\n### Prompt global :\nAnalyse compl√®te couvrant actualit√©, finances, juridique et socio-√©conomique",
        "height": 400,
        "width": 600,
        "color": 3
      },
      "id": "e49e1dea-bdc8-4255-ba14-c9bc3ee07951",
      "name": "üìñ Documentation",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1320,
        -460
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "messages": {
          "messagesUi": [
            {
              "role": "system",
              "content": "Tu es un expert en analyse municipale et en intelligence territoriale. R√©ponds en fran√ßais avec des informations pr√©cises et v√©rifiables."
            },
            {
              "content": "={{ $('üèõÔ∏è Extraction Nom Ville').item.json.ville_nom }}"
            },
            {}
          ]
        },
        "additionalFields": {}
      },
      "type": "@watzon/n8n-nodes-perplexity.perplexity",
      "typeVersion": 1,
      "position": [
        -120,
        220
      ],
      "id": "4228592c-9773-44ad-a549-ae9bf2a84ef4",
      "name": "Perplexity - Donn√©es filtr√©es",
      "notesInFlow": false,
      "credentials": {
        "perplexityApi": {
          "id": "l9xmENBp3vpHTyQe",
          "name": "Perplexity account"
        }
      }
    }
  ],
  "connections": {
    "üîß Configuration du Prompt": {
      "main": [
        [
          {
            "node": "‚úÖ V√©rification Ville",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üì• Webhook Entr√©e": {
      "main": [
        [
          {
            "node": "üèõÔ∏è Extraction Nom Ville",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üèõÔ∏è Extraction Nom Ville": {
      "main": [
        [
          {
            "node": "üîß Configuration du Prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚úÖ V√©rification Ville": {
      "main": [
        [
          {
            "node": "üîç Agent Perplexity Global",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "‚ùå Erreur Ville Manquante",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîç Agent Perplexity Global": {
      "main": [
        [
          {
            "node": "üìä Consolidation Donn√©es",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìä Consolidation Donn√©es": {
      "main": [
        []
      ]
    },
    "üìã Cr√©ation Dossier Municipal": {
      "main": [
        [
          {
            "node": "üé® G√©n√©ration HTML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ü§ñ GPT Dossier": {
      "ai_languageModel": [
        [
          {
            "node": "üìã Cr√©ation Dossier Municipal",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "üåê GPT HTML": {
      "ai_languageModel": [
        [
          {
            "node": "üé® G√©n√©ration HTML",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "üé® G√©n√©ration HTML": {
      "main": [
        [
          {
            "node": "üì§ R√©ponse Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚ùå Erreur Ville Manquante": {
      "main": [
        [
          {
            "node": "üì§ R√©ponse Erreur",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Perplexity - Donn√©es filtr√©es": {
      "main": [
        []
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "a89ff51014f84c47ef4d4895b220e462755d019d580bee747c11ae9b6bc115eb"
  }
}