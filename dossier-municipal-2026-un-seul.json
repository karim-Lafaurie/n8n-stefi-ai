{
    "nodes": [
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "prompt_global",
                "name": "prompt_global",
                "type": "string",
                "value": "R√©alise une analyse municipale compl√®te de {{ $json.ville_nom }} en France pour un dossier √©lectoral municipal 2026. Couvre TOUS ces aspects : 1) ACTUALIT√â R√âCENTE (12 derniers mois) : √©v√©nements, projets municipaux, d√©veloppements √©conomiques, probl√®mes sociaux, d√©cisions du conseil municipal. 2) SITUATION FINANCI√àRE : budget municipal, d√©penses principales, recettes, endettement, investissements r√©cents, projets financ√©s, perspectives budg√©taires. 3) ASPECTS JURIDIQUES : d√©lib√©rations municipales r√©centes, contentieux en cours, d√©cisions administratives importantes, projets d'urbanisme, r√©glementations locales. 4) SOCIO-√âCONOMIQUE : d√©mographie, ch√¥mage, entreprises locales, commerces, immobilier, √©ducation, sant√©, transports, culture, √©quipements publics. Structure ta r√©ponse avec ces 4 sections distinctes et d√©taill√©es."
              }
            ]
          },
          "options": {}
        },
        "id": "e1d14abe-3562-4e01-8c31-fc004748bd3c",
        "name": "üîß Configuration du Prompt",
        "type": "n8n-nodes-base.set",
        "position": [
          -1120,
          20
        ],
        "typeVersion": 3.4
      },
      {
        "parameters": {
          "path": "dossier-municipal",
          "responseMode": "responseNode",
          "options": {}
        },
        "id": "632925de-baff-4352-aa81-722914f6ebdd",
        "name": "üì• Webhook Entr√©e",
        "type": "n8n-nodes-base.webhook",
        "position": [
          -1340,
          20
        ],
        "webhookId": "dossier-municipal-2026",
        "typeVersion": 2
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "ville_nom",
                "name": "ville_nom",
                "type": "string",
                "value": "={{ $('üì• Webhook Entr√©e').item.json.query?.ville || $('üì• Webhook Entr√©e').item.json.ville || $('üì• Webhook Entr√©e').item.json.query?.topic || $('üì• Webhook Entr√©e').item.json.topic || '' }}"
              }
            ]
          },
          "options": {}
        },
        "id": "ecdc34ef-78b5-4468-a991-eb00e9bf90e7",
        "name": "üèõÔ∏è Extraction Nom Ville",
        "type": "n8n-nodes-base.set",
        "position": [
          -900,
          20
        ],
        "typeVersion": 3.4
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "version": 2,
              "leftValue": "",
              "caseSensitive": true,
              "typeValidation": "strict"
            },
            "combinator": "and",
            "conditions": [
              {
                "id": "ville-existe",
                "operator": {
                  "type": "string",
                  "operation": "notEmpty",
                  "singleValue": true
                },
                "leftValue": "={{ $('üèõÔ∏è Extraction Nom Ville').item.json.ville_nom }}",
                "rightValue": ""
              }
            ]
          },
          "options": {}
        },
        "id": "799524ae-26d2-4ac2-b448-dd61f6a8a69c",
        "name": "‚úÖ V√©rification Ville",
        "type": "n8n-nodes-base.if",
        "position": [
          -680,
          20
        ],
        "typeVersion": 2.2
      },
      {
        "parameters": {
          "model": "sonar-deep-research",
          "messages": {
            "messagesUi": [
              {
                "role": "system",
                "content": "Tu es un expert en analyse municipale fran√ßaise. R√©ponds en fran√ßais avec des informations pr√©cises et v√©rifiables."
              },
              {
                "content": "=R√©alise une analyse municipale compl√®te de {{ $('üèõÔ∏è Extraction Nom Ville').item.json.ville_nom }} en France pour un dossier √©lectoral municipal 2026. Couvre ces aspects : 1) ACTUALIT√â R√âCENTE (12 derniers mois), 2) SITUATION FINANCI√àRE, 3) ASPECTS JURIDIQUES, 4) SOCIO-√âCONOMIQUE. Structure ta r√©ponse avec ces 4 sections distinctes et d√©taill√©es."
              }
            ]
          },
          "additionalFields": {}
        },
        "id": "c557654e-16fd-4c7b-9457-232e892dbcf3",
        "name": "üîç Agent Perplexity Global",
        "type": "@watzon/n8n-nodes-perplexity.perplexity",
        "position": [
          -460,
          20
        ],
        "typeVersion": 1,
        "credentials": {
          "perplexityApi": {
            "id": "l9xmENBp3vpHTyQe",
            "name": "Perplexity account"
          }
        }
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "analyse_complete",
                "name": "analyse_complete",
                "type": "string",
                "value": "={{ $('üîç Agent Perplexity Global').item?.json?.content || 'Donn√©es d\\'analyse non disponibles' }}"
              },
              {
                "id": "ville",
                "name": "ville",
                "type": "string",
                "value": "={{ $('üèõÔ∏è Extraction Nom Ville').item.json.ville_nom }}"
              }
            ]
          },
          "options": {}
        },
        "id": "095fd73f-0f94-40c2-88a6-4167258bd885",
        "name": "üìä Consolidation Donn√©es",
        "type": "n8n-nodes-base.set",
        "position": [
          -220,
          20
        ],
        "typeVersion": 3.4
      },
      {
        "parameters": {
          "promptType": "define",
          "text": "=Cr√©√© un dossier municipal complet pour un candidat aux √©lections municipales 2026 de {{ $json.ville }}. Synth√©tise les informations fournies et structure le contenu avec des sections claires : Pr√©sentation de la commune, Enjeux principaux, D√©fis √† relever, Opportunit√©s de d√©veloppement, et Recommandations strat√©giques pour la campagne.\n\n## Analyse compl√®te :\n{{ $json.analyse_complete }}\n\n---\n\nCr√©e un dossier municipal structur√© en format JSON avec cette structure exacte :\n\n{\n  \"dossier\": {\n    \"ville\": \"nom de la ville\",\n    \"date_creation\": \"date actuelle\",\n    \"resume_executif\": \"r√©sum√© en 2-3 phrases\",\n    \"sections\": {\n      \"presentation_commune\": {\n        \"titre\": \"Pr√©sentation de la commune\",\n        \"contenu\": \"description d√©taill√©e\",\n        \"points_cles\": [\"point1\", \"point2\", \"point3\"]\n      },\n      \"enjeux_principaux\": {\n        \"titre\": \"Enjeux principaux\",\n        \"contenu\": \"analyse des enjeux\",\n        \"points_cles\": [\"enjeu1\", \"enjeu2\", \"enjeu3\"]\n      },\n      \"defis_relever\": {\n        \"titre\": \"D√©fis √† relever\",\n        \"contenu\": \"identification des d√©fis\",\n        \"points_cles\": [\"defi1\", \"defi2\", \"defi3\"]\n      },\n      \"opportunites\": {\n        \"titre\": \"Opportunit√©s de d√©veloppement\",\n        \"contenu\": \"analyse des opportunit√©s\",\n        \"points_cles\": [\"opportunite1\", \"opportunite2\", \"opportunite3\"]\n      },\n      \"recommandations\": {\n        \"titre\": \"Recommandations strat√©giques\",\n        \"contenu\": \"strat√©gies pour la campagne\",\n        \"points_cles\": [\"recommandation1\", \"recommandation2\", \"recommandation3\"]\n      }\n    },\n    \"sources\": [\"source1\", \"source2\", \"source3\"]\n  }\n}\n\nR√©ponds uniquement avec le JSON, sans texte d'explication."
        },
        "id": "fa0c0c39-1776-463e-a482-d8f553dd64d3",
        "name": "üìã Cr√©ation Dossier Municipal",
        "type": "@n8n/n8n-nodes-langchain.chainLlm",
        "position": [
          60,
          20
        ],
        "typeVersion": 1.4
      },
      {
        "parameters": {
          "model": "gpt-4o-mini-2024-07-18",
          "options": {
            "responseFormat": "json_object",
            "temperature": 0.1
          }
        },
        "id": "544104f1-0c33-42fb-81fb-5054b5a8fe36",
        "name": "ü§ñ GPT Dossier",
        "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
        "position": [
          60,
          200
        ],
        "typeVersion": 1,
        "credentials": {
          "openAiApi": {
            "id": "x5omHDQyKcMdm5sj",
            "name": "OpenAi account"
          }
        }
      },
      {
        "parameters": {
          "model": "gpt-4o-mini-2024-07-18",
          "options": {
            "responseFormat": "text",
            "temperature": 0.1
          }
        },
        "id": "9b8f468f-bb0b-4cb1-acdf-d311fc2063fc",
        "name": "üåê GPT HTML",
        "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
        "position": [
          380,
          200
        ],
        "typeVersion": 1,
        "credentials": {
          "openAiApi": {
            "id": "x5omHDQyKcMdm5sj",
            "name": "OpenAi account"
          }
        }
      },
      {
        "parameters": {
          "promptType": "define",
          "text": "=Cr√©e un document HTML complet et moderne pour ce dossier municipal. Utilise TailwindCSS pour un design professionnel et responsive.\n\nStructure :\n- Header avec le nom de la ville et date\n- Navigation par sections\n- Contenu organis√© avec des cartes TailwindCSS\n- Code couleur : bleu pour les titres, vert pour les opportunit√©s, orange pour les d√©fis\n- Footer avec les sources\n\nDonn√©es du dossier :\n{{ $json.text }}\n\nRequirements :\n- Document HTML complet avec doctype\n- Utilise TailwindCSS via CDN\n- Design responsive et moderne\n- Navigation fluide entre sections\n- Formatage professionnel pour un candidat\n- Langue fran√ßaise exclusivement\n- Une seule ligne de HTML (sans retours √† la ligne)\n\nR√©ponds uniquement avec le code HTML, sans explications."
        },
        "id": "992b0cd1-6b51-4a2c-9c10-b4f1470567ff",
        "name": "üé® G√©n√©ration HTML",
        "type": "@n8n/n8n-nodes-langchain.chainLlm",
        "position": [
          380,
          20
        ],
        "typeVersion": 1.4
      },
      {
        "parameters": {
          "respondWith": "text",
          "responseBody": "={{ $json.text }}",
          "options": {
            "responseHeaders": {
              "entries": [
                {
                  "name": "Content-Type",
                  "value": "text/html; charset=utf-8"
                }
              ]
            }
          }
        },
        "id": "3d4b2205-2855-46ff-aa29-dc8ebb3de743",
        "name": "üì§ R√©ponse Webhook",
        "type": "n8n-nodes-base.respondToWebhook",
        "position": [
          700,
          20
        ],
        "typeVersion": 1.1
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "erreur",
                "name": "erreur",
                "type": "string",
                "value": "Erreur : Nom de ville manquant. Veuillez sp√©cifier le param√®tre 'ville' ou 'topic' dans votre requ√™te. Exemples: ?ville=Paris ou ?topic=Lyon"
              },
              {
                "id": "debug_data",
                "name": "debug_data",
                "type": "object",
                "value": "={{ $('üì• Webhook Entr√©e').item.json }}"
              }
            ]
          },
          "options": {}
        },
        "id": "211dbaa7-577e-440e-9617-f71bcdf2b20e",
        "name": "‚ùå Erreur Ville Manquante",
        "type": "n8n-nodes-base.set",
        "position": [
          -680,
          200
        ],
        "typeVersion": 3.4
      },
      {
        "parameters": {
          "respondWith": "json",
          "responseBody": "={{ { \"erreur\": $json.erreur, \"debug\": $json.debug_data, \"aide\": \"Utilisez les param√®tres: ?ville=NomVille ou ?topic=NomVille\" } }}",
          "options": {}
        },
        "id": "3ac99961-7174-4dff-921e-2961892f7fca",
        "name": "üì§ R√©ponse Erreur",
        "type": "n8n-nodes-base.respondToWebhook",
        "position": [
          -480,
          560
        ],
        "typeVersion": 1.1
      },
      {
        "parameters": {
          "content": "## üèõÔ∏è WORKFLOW DOSSIER MUNICIPAL 2026 - VERSION SIMPLIFI√âE\n\nCe workflow g√©n√®re un dossier complet pour un candidat aux √©lections municipales.\n\n### Utilisation :\n- URL : /dossier-municipal?ville=NOM_VILLE\n- Exemple : /dossier-municipal?ville=Lyon\n\n### Architecture simplifi√©e :\n- üîç Un seul agent Perplexity global\n- üìä Consolidation directe\n- üé® G√©n√©ration HTML finale\n\n### Prompt global :\nAnalyse compl√®te couvrant actualit√©, finances, juridique et socio-√©conomique",
          "height": 400,
          "width": 600,
          "color": 3
        },
        "id": "2d617471-5b3e-4835-b3c0-7ca6dd3dc1c8",
        "name": "üìñ Documentation",
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          -1340,
          -360
        ],
        "typeVersion": 1
      }
    ],
    "connections": {
      "üîß Configuration du Prompt": {
        "main": [
          [
            {
              "node": "‚úÖ V√©rification Ville",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "üì• Webhook Entr√©e": {
        "main": [
          [
            {
              "node": "üèõÔ∏è Extraction Nom Ville",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "üèõÔ∏è Extraction Nom Ville": {
        "main": [
          [
            {
              "node": "üîß Configuration du Prompt",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "‚úÖ V√©rification Ville": {
        "main": [
          [
            {
              "node": "üîç Agent Perplexity Global",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "‚ùå Erreur Ville Manquante",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "üîç Agent Perplexity Global": {
        "main": [
          [
            {
              "node": "üìä Consolidation Donn√©es",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "üìä Consolidation Donn√©es": {
        "main": [
          [
            {
              "node": "üìã Cr√©ation Dossier Municipal",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "üìã Cr√©ation Dossier Municipal": {
        "main": [
          [
            {
              "node": "üé® G√©n√©ration HTML",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "ü§ñ GPT Dossier": {
        "ai_languageModel": [
          [
            {
              "node": "üìã Cr√©ation Dossier Municipal",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "üåê GPT HTML": {
        "ai_languageModel": [
          [
            {
              "node": "üé® G√©n√©ration HTML",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "üé® G√©n√©ration HTML": {
        "main": [
          [
            {
              "node": "üì§ R√©ponse Webhook",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "‚ùå Erreur Ville Manquante": {
        "main": [
          [
            {
              "node": "üì§ R√©ponse Erreur",
              "type": "main",
              "index": 0
            }
          ]
        ]
      }
    },
    "pinData": {},
    "meta": {
      "instanceId": "a89ff51014f84c47ef4d4895b220e462755d019d580bee747c11ae9b6bc115eb"
    }
}